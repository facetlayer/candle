#!/usr/bin/env node

/**
 * Test runner for Candle CLI
 *
 * This script makes it easier to run Candle with a custom database directory
 * for testing purposes. It wraps the candle CLI and sets CANDLE_DATABASE_DIR
 * when --database-dir is provided.
 *
 * Usage:
 *   bin/test-candle --database-dir /tmp/test-db list
 *   bin/test-candle --database-dir ./test-workspace start my-service
 *   bin/test-candle list  # Without --database-dir, passes through normally
 */

import { runShellCommand } from '@facetlayer/subprocess-wrapper';
import { dirname, join } from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

interface ParsedArgs {
  databaseDir: string | null;
  candleArgs: string[];
}

function parseArgs(argv: string[]): ParsedArgs {
  const args = argv.slice(2); // Skip node and script path
  let databaseDir: string | null = null;
  const candleArgs: string[] = [];

  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--database-dir') {
      if (i + 1 < args.length) {
        databaseDir = args[i + 1];
        i++; // Skip the value
      } else {
        console.error('Error: --database-dir requires a value');
        process.exit(1);
      }
    } else {
      candleArgs.push(args[i]);
    }
  }

  return { databaseDir, candleArgs };
}

async function main() {
  const { databaseDir, candleArgs } = parseArgs(process.argv);

  const candlePath = join(__dirname, '..', 'src', 'main-cli.ts');

  const env: Record<string, string> = { ...process.env } as Record<string, string>;

  if (databaseDir) {
    env.CANDLE_DATABASE_DIR = databaseDir;
  }

  const result = await runShellCommand('node', [candlePath, ...candleArgs], {
    env,
    cwd: process.cwd(),
  });

  // Print stdout and stderr
  if (result.stdout) {
    process.stdout.write(result.stdout);
  }
  if (result.stderr) {
    process.stderr.write(result.stderr);
  }

  process.exit(result.code ?? 0);
}

main().catch(error => {
  console.error(error);
  process.exit(1);
});
